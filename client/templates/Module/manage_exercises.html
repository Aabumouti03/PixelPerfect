{% extends 'client/client_base.html' %}
{% load static %}

{% block content %}
<div class="content">
    <h2 class="page-title">Manage Exercises</h2>
    <link rel="stylesheet" href="{% static 'client/css/module_style.css' %}">

    <div class="top-buttons">
        <a href="{% url 'add_exercise' %}" class="add-btn">+ Add Exercise</a>
    </div>

    <div class="module-list">
        {% for exercise in exercises %}
            <div class="module-card">
                <div class="module-header">
                    <div class="module-title">
                        <input type="text" value="{{ exercise.title }}" id="title-{{ exercise.id }}" class="edit-input" readonly>
                    </div>
                    <div class="module-actions">
                        <button class="edit-btn" onclick="enableEdit('{{ exercise.id }}')">‚úèÔ∏è Edit</button>
                        <button class="save-btn hidden" onclick="saveExercise('{{ exercise.id }}')">üíæ Save</button>
                        <button class="toggle-btn" onclick="toggleExercise('{{ exercise.id }}')">
                            <i class="fas fa-chevron-left" id="toggle-icon-{{ exercise.id }}"></i>
                        </button>
                    </div>
                </div>

                <div id="exercise-{{ exercise.id }}" class="module-content">
                    <h4>Questions:</h4>
                    {% if exercise.questions.all %}
                        <ul class="exercise-questions">
                            {% for question in exercise.questions.all %}
                                <li>
                                    <input type="text" value="{{ question.question_text }}" id="question-{{ question.id }}" class="edit-input" readonly>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No questions available.</p>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <p>No exercises found.</p>
        {% endfor %}
    </div>
</div>

<style>
    /* Override default styling */
    .content {
        flex-grow: 1;
        padding: 30px;
    }

    .module-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .module-card {
        background: #f8f9fa;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-left: 6px solid #73c4fd;
        padding: 15px;
        transition: background 0.3s ease-in-out;
        width: 100%;
    }

    .module-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 15px;
        border-radius: 10px;
        transition: background 0.2s ease-in-out;
    }

    .module-header:hover {
        background: rgba(115, 196, 253, 0.2);
    }

    .module-title input {
        border: none;
        font-size: 20px;
        width: 100%;
        font-weight: bold;
        outline: none;
    }

    .edit-input {
        border: none;
        background: transparent;
        outline: none;
        font-size: 18px;
        width: 100%;
        padding: 5px;
    }

    .editing {
        border: 1px solid #007bff;
        background: #f0f8ff;
        padding: 5px;
    }

    .hidden {
        display: none;
    }

    .module-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .edit-btn, .save-btn {
        background-color: #FD5402;
        color: white;
        padding: 7px 15px;
        border: none;
        border-radius: 20px;
        font-size: 14px;
        transition: 0.3s;
    }

    .edit-btn:hover, .save-btn:hover {
        background: #e04e00;
        transform: scale(1.05);
    }

    .toggle-btn {
        background: none;
        color: #FD5402;
        border: none;
        font-size: 18px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s ease-in-out;
    }

    .module-content {
        display: none;
        padding: 15px;
        background: white;
    }

    .module-content.show {
        display: block;
    }

    .exercise-questions {
        padding-left: 20px;
        list-style: none;
    }

    .exercise-questions li {
        margin-bottom: 5px;
    }
</style>

<script>
    function enableEdit(exerciseId) {
        document.getElementById(`title-${exerciseId}`).readOnly = false;
        document.getElementById(`title-${exerciseId}`).classList.add('editing');

        document.querySelectorAll(`#exercise-${exerciseId} .edit-input`).forEach(input => {
            input.readOnly = false;
            input.classList.add('editing');
        });

        document.querySelector(`#exercise-${exerciseId} .edit-btn`).classList.add('hidden');
        document.querySelector(`#exercise-${exerciseId} .save-btn`).classList.remove('hidden');
    }

    function saveExercise(exerciseId) {
        let title = document.getElementById(`title-${exerciseId}`).value;
        let questionElements = document.querySelectorAll(`#exercise-${exerciseId} .exercise-questions input`);
        let questions = [];

        questionElements.forEach(input => {
            let questionId = input.id.split('-')[1];
            let questionText = input.value;
            questions.push({ id: questionId, text: questionText });
        });

        fetch(`/update_exercise/${exerciseId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ title: title, questions: questions })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("‚úÖ Exercise updated successfully!");
                location.reload();
            } else {
                alert("‚ùå Error updating exercise.");
            }
        })
        .catch(error => console.error("‚ö†Ô∏è Error:", error));
    }

    function toggleExercise(exerciseId) {
        const content = document.getElementById(`exercise-${exerciseId}`);
        const icon = document.getElementById(`toggle-icon-${exerciseId}`);

        content.classList.toggle("show");

        if (content.classList.contains("show")) {
            icon.classList.remove("fa-chevron-left");
            icon.classList.add("fa-chevron-down");
        } else {
            icon.classList.remove("fa-chevron-down");
            icon.classList.add("fa-chevron-left");
        }
    }
</script>

{% endblock %}
